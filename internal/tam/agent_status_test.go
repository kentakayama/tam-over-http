/*
 * Copyright (c) 2025 SECOM CO., LTD. All Rights reserved.
 *
 * SPDX-License-Identifier: BSD-2-Clause
 */

package tam

import (
	"testing"

	"github.com/fxamacker/cbor/v2"
	"github.com/kentakayama/tam-over-http/internal/domain/model"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestAgentStatus_Marshal_OK(t *testing.T) {
	/*
		[
			[
				'kid-of-teep-agent-A',
				{
					"attributes": {
						/ ueid / 256: 'device-123'
					},
					"wapp_list": [
						[
							/ SUIT_Component_Identifier: / << ['app1.wasm'] >>,
							/ manifest-sequence-number: / 3
						],
						[
							/ SUIT_Component_Identifier: / << ['app2.wasm'] >>,
							/ manifest-sequence-number: / 2
						]
					]
				}
			],
			[
				'kid-of-teep-agent-B',
				{
					"attributes": {
						/ ueid / 256: 'device-456'
					},
					"wapp_list": [
						[
							/ SUIT_Component_Identifier: / << ['app1.wasm'] >>,
							/ manifest-sequence-number: / 2
						]
					]
				}
			]
		]
	*/
	expected := []byte{
		0x82, 0x82, 0x53, 0x6B, 0x69, 0x64, 0x2D, 0x6F, 0x66, 0x2D, 0x74, 0x65, 0x65, 0x70, 0x2D, 0x61,
		0x67, 0x65, 0x6E, 0x74, 0x2D, 0x41, 0xA2, 0x6A, 0x61, 0x74, 0x74, 0x72, 0x69, 0x62, 0x75, 0x74,
		0x65, 0x73, 0xA1, 0x19, 0x01, 0x00, 0x4A, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x2D, 0x31, 0x32,
		0x33, 0x69, 0x77, 0x61, 0x70, 0x70, 0x5F, 0x6C, 0x69, 0x73, 0x74, 0x82, 0x82, 0x4B, 0x81, 0x49,
		0x61, 0x70, 0x70, 0x31, 0x2E, 0x77, 0x61, 0x73, 0x6D, 0x03, 0x82, 0x4B, 0x81, 0x49, 0x61, 0x70,
		0x70, 0x32, 0x2E, 0x77, 0x61, 0x73, 0x6D, 0x02, 0x82, 0x53, 0x6B, 0x69, 0x64, 0x2D, 0x6F, 0x66,
		0x2D, 0x74, 0x65, 0x65, 0x70, 0x2D, 0x61, 0x67, 0x65, 0x6E, 0x74, 0x2D, 0x42, 0xA2, 0x6A, 0x61,
		0x74, 0x74, 0x72, 0x69, 0x62, 0x75, 0x74, 0x65, 0x73, 0xA1, 0x19, 0x01, 0x00, 0x4A, 0x64, 0x65,
		0x76, 0x69, 0x63, 0x65, 0x2D, 0x34, 0x35, 0x36, 0x69, 0x77, 0x61, 0x70, 0x70, 0x5F, 0x6C, 0x69,
		0x73, 0x74, 0x81, 0x82, 0x4B, 0x81, 0x49, 0x61, 0x70, 0x70, 0x31, 0x2E, 0x77, 0x61, 0x73, 0x6D,
		0x02,
	}

	s := []model.AgentStatus{
		{
			AgentKID: []byte{
				0x6B, 0x69, 0x64, 0x2D, 0x6F, 0x66, 0x2D, 0x74, 0x65, 0x65, 0x70, 0x2D, 0x61, 0x67, 0x65, 0x6E, 0x74, 0x2D, 0x41, // 'kid-of-teep-agent-A'
			},
			DeviceUEID: []byte{0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x2D, 0x31, 0x32, 0x33},
			SuitManifests: []model.SuitManifestOverview{
				{
					TrustedComponentID: []byte{0x81, 0x49, 0x61, 0x70, 0x70, 0x31, 0x2E, 0x77, 0x61, 0x73, 0x6D}, // ['app1.wasm']
					SequenceNumber:     3,
				},
				{
					TrustedComponentID: []byte{0x81, 0x49, 0x61, 0x70, 0x70, 0x32, 0x2E, 0x77, 0x61, 0x73, 0x6D}, // ['app1.wasm']
					SequenceNumber:     2,
				},
			},
		},
		{
			AgentKID: []byte{
				0x6B, 0x69, 0x64, 0x2D, 0x6F, 0x66, 0x2D, 0x74, 0x65, 0x65, 0x70, 0x2D, 0x61, 0x67, 0x65, 0x6E, 0x74, 0x2D, 0x42, // 'kid-of-teep-agent-B'
			},
			DeviceUEID: []byte{0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x2D, 0x34, 0x35, 0x36},
			SuitManifests: []model.SuitManifestOverview{
				{
					TrustedComponentID: []byte{0x81, 0x49, 0x61, 0x70, 0x70, 0x31, 0x2E, 0x77, 0x61, 0x73, 0x6D}, // ['app1.wasm']
					SequenceNumber:     2,
				},
			},
		},
	}
	encoded, err := cbor.Marshal(s)
	require.Nil(t, err)
	assert.Equal(t, expected, encoded)
}
